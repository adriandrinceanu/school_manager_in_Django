{% extends 'base.html' %}
{% load static %}

{% block content %}

<main>
  <div class="container py-4">
  
    <div class="row align-items-md-stretch">
      <div class="col-md-4" style="height: auto; overflow: auto; position: sticky; top: 50px;" >
        <div class="h-100 p-5 text-bg-light rounded-1 border">
          <img style='width:260px; height:auto;' src="{{ student.profile_pic.url }}" class="card-img-top" alt="{{ student.first_name }} {{ student.last_name }}">
          <h2>{{ student.first_name }} {{ student.last_name }}</h2>
          <p>Student</p>
          <hr class="styled-hr">
          <p>{{ year }}, {{ year_group }}</p>
          <p>Teachers: 
          {% for teacher in student.teachers.all %}
           {{teacher.name}}, 
          {% endfor %}
        </p>
        </div>
      </div>
      <div class="col-md-8">
        <div class="h-100 p-5  text-bg-light border rounded-1" >
          <h2>{{ student.first_name }}'s wall</h2>

          {% for status in statuses %}
          <div class="col ">
            <div class="card shadow-sm text-bg-light border rounded-1">
              <div class="card-body">
                <h6 class="card-text">{{ status.content }}</h6>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-body-secondary">{{ status.timestamp }}</small>
                </div>
              </div>
            </div>
          </div>
          <br />
          {% empty %}
          <p>No status yet. {{ student.last_name }} did not post anything yet.</p>
          {% endfor %}
          
        </div>
      </div>
    </div>
<!-- chatbox -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1030">
      <div class="card">
          <div class="card-header">
              Chat with {{ student.last_name }}
          </div>
          <div class="card-body">
              <div style="height: 200px; overflow-y: auto;">
                  <!-- Chat messages will go here -->
                  <textarea id="chat-log" readonly></textarea>
              </div>
          </div>
          <div class="card-footer">
              <form id="chat-form">
                  <div class="input-group">
                      <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message...">
                      <button id="chat-message-submit"  class="btn btn-primary" type="submit">Send</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

</main>

<script>
  var socket = new WebSocket(
      'ws://' + window.location.host +
      '/ws/chat/{{ room_name }}/',
      [],
      {credentials: 'include'} 
      );

      socket.onmessage = function(e) {
        console.log('Received data:', e.data);  // Log the raw data received
        var data = JSON.parse(e.data);
        var message = data['message'];
        var username = data['username'];
        var timestamp = data['timestamp'];
        // document.querySelector('#chat-log').value += (username + ' at ' + timestamp + ': ' + message + '\n');

        // Log the parsed message
        console.log('Parsed message:', username + ' at ' + timestamp + ': ' + message);

        // Update the chat log
        var chatLog = document.querySelector('#chat-log');
        chatLog.value += (username + ' at ' + timestamp + ': ' + message + '\n');

        // Log the updated chat log value
        console.log('Updated chat log:', chatLog.value);
        
        };

  socket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
      if (e.keyCode === 13) {  // enter, return
          document.querySelector('#chat-message-submit').click();
      }
  };

  document.querySelector('#chat-message-submit').onclick = function(e) {
    // Prevent the form from submitting
    e.preventDefault();
    
    var messageInputDom = document.querySelector('#chat-message-input');
    var message = messageInputDom.value;
    
    // Log the message that is being sent
    console.log('Sending message:', message);
    
    socket.send(JSON.stringify({
        'message': message
    }));

    messageInputDom.value = '';
};

document.querySelector('#chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) {  // enter, return
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        
        // Log the message that is being sent
        console.log('Sending message:', message);
        
        document.querySelector('#chat-message-submit').click();
    }
};
</script>


{% endblock %}